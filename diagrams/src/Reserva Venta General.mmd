sequenceDiagram
	autonumber

    %% PARTICIPANTES
    actor Cliente
	participant AdminPortal as Punto de Venta
	participant AdminAPI as API Admin
    participant SeatsIo

	%% ======================================
    %% VENTA EN GENERAL - COBRO INMEDIATO VENTA EN GENERAL - COBRO DIFERIDO A UN PAGO
    %% ======================================
	rect rgb(255, 250, 235)
		note over Cliente,SeatsIo: *** VENTA EN GENERAL - COBRO DIFERIDO A UN PAGO ***

		Cliente ->> AdminPortal: El cliente empieza proceso de renovacion de Xolopass
		AdminPortal ->> AdminAPI: A hace peticiones para cargar la informacion necesaria
		AdminAPI -->> SeatsIo: Solicita la informacion de los asientos <br> await Client.Events.RetrieveObjectInfosAsync("event34", new string[] {"C-11", "GA1"});
		SeatsIo -->> AdminAPI: Regresa la informacion solicitada
		AdminAPI -->> AdminAPI: Recalcula precios
		AdminAPI ->> AdminPortal: Regresa la informacion necesaria de los asientos y precio
		AdminPortal ->> Cliente: Se le da informacion al cliente (disponibilidad y precio)
		Cliente ->> AdminPortal: Confirma asientos
		AdminPortal ->> Cliente: Informa opciones de pago
		Cliente ->> AdminPortal: Cliente confirma metodo de pago
		AdminPortal ->> AdminAPI: Solicita reservar asientos
		AdminAPI -->> SeatsIo: Genera llave de reserva <br> await Client.HoldTokens.CreateAsync()
		SeatsIo -->> AdminAPI: Retorna llave de reserva <br> wvXbB9MlHt
		AdminAPI -->> SeatsIo: Reserva los asientos con la llave de reserva <br> await Client.Events.HoldAsync("event1", new [] { "A-3", "A-5" }, "wvXbB9MlHt");

		alt Reserva exitosa
			SeatsIo -->> AdminAPI: SeatsIo confirma la reserva de los asientos
			AdminAPI ->> AdminPortal: Confirma disponibilidad de los asiento para continuar con el pago
		else Reserva fallida
			SeatsIo -->> AdminAPI: SeatsIo informa que los asientos ya estan reservados
			AdminAPI ->> AdminPortal: Se informa que los asientos ya no estan disponibles
			AdminPortal ->> Cliente: Se le informa que lso asientos ya no estan disponibles
			Cliente ->> Cliente: El cliente decide si desea intentar con otros asientos o cancela el proceso
		end

		AdminPortal ->> AdminAPI: Envia informacion de pago para ser procesada
		AdminAPI -->> AdminAPI: Genera referencia incluyendo el monto y fecha limite de pago <br> Ejemplo, Oxxo Pay
		AdminAPI -->> AdminAPI: Guarda registro del pago diferido para su monitoreo
		AdminAPI -->> SeatsIo: Actualiza el status de los asientos a reservados <br> await Client.Events.ChangeObjectStatusAsync("event1", new [] { "A-3", "A-5" }, "booked", "wvXbB9MlHt");
		SeatsIo -->> AdminAPI: Regresa confirmacion de que los asientos estan reservados 
		AdminAPI ->> AdminPortal: Envia referencia de pago
		AdminPortal ->> Cliente: Se entrega referencia para poder pagar		

		alt Pago confirmado por Webhook
			AdminAPI -->> AdminAPI: Recibe confirmacion del pago en Oxxo Pay
			AdminAPI -->> SeatsIo: Actualiza el status de los asientos junto con el token de reserva <br> await Client.Events.ChangeObjectStatusAsync("event1", new [] { "A-3", "A-5" }, "sold", "wvXbB9MlHt");
			SeatsIo --> AdminAPI: Confirma cambio de estatus
			AdminAPI ->> Cliente: Envia correo y entrega Xolopass digital
			Cliente ->> AdminPortal: Puede pedir su Xolopass fisico (Taquilla)
			AdminPortal ->> Cliente: Entrega Xolopass fisico de ser necesario
		else Pago no confirmado
			AdminAPI -->> AdminAPI: Revisa referencia de referencias de pago vencidos
			AdminAPI -->> SeatsIo: Libera asientos en base a su referencia usando la llave de reserva <> await Client.Events.ChangeObjectStatusAsync("event1", new [] { "A-3", "A-5" }, "free", "wvXbB9MlHt");
			SeatsIo -->> AdminAPI: Confirma que los asientos fueron liberados
		end
	end

	%% ======================================
    %% VENTA EN GENERAL - COBRO INMEDIATO
    %% ======================================
	rect rgb(255, 228, 180)
		note over Cliente,SeatsIo: *** VENTA EN GENERAL - COBRO INMEDIATO ***

		Cliente ->> AdminPortal: El cliente empieza proceso de renovacion de Xolopass
		AdminPortal ->> AdminAPI: A hace peticiones para cargar la informacion necesaria
		AdminAPI -->> SeatsIo: Solicita la informacion de los asientos <br> await Client.Events.RetrieveObjectInfosAsync("event34", new string[] {"C-11", "GA1"});
		SeatsIo -->> AdminAPI: Regresa la informacion solicitada
		AdminAPI -->> AdminAPI: Recalcula precios
		AdminAPI ->> AdminPortal: Regresa la informacion necesaria de los asientos y precio
		AdminPortal ->> Cliente: Se le da informacion al cliente (disponibilidad y precio)
		Cliente ->> AdminPortal: Confirma asientos
		AdminPortal ->> Cliente: Informa opciones de pago
		Cliente ->> AdminPortal: Cliente confirma metodo de pago
		AdminPortal ->> AdminAPI: Solicita reservar asientos
		AdminAPI -->> SeatsIo: Genera llave de reserva <br> await Client.HoldTokens.CreateAsync()
		SeatsIo -->> AdminAPI: Retorna llave de reserva <br> wvXbB9MlHt
		AdminAPI -->> SeatsIo: Reserva los asientos con la llave de reserva <br> await Client.Events.HoldAsync("event1", new [] { "A-3", "A-5" }, "wvXbB9MlHt");

		alt Reserva exitosa
			SeatsIo -->> AdminAPI: SeatsIo confirma la reserva de los asientos
			AdminAPI ->> AdminPortal: Confirma disponibilidad de los asiento para continuar con el pago
		else Reserva fallida
			SeatsIo -->> AdminAPI: SeatsIo informa que los asientos ya estan reservados
			AdminAPI ->> AdminPortal: Informa que los asientos ya no estan disponibles
			AdminPortal ->> Cliente: Se le informa que los asientos ya no estan disponibles
			Cliente ->> Cliente: El cliente decide si desea intentar con otros asientos o cancela el proceso
		end

		AdminPortal ->> AdminAPI: Envia informacion de pago para ser procesada
		AdminAPI -->> AdminAPI: Procesa informacion de pago

		alt Pago exitoso
			AdminAPI -->> AdminAPI: Confirma pago exitoso
			AdminAPI -->> SeatsIo: Actualiza el status de los asientos junto con el token de reserva <br> await Client.Events.ChangeObjectStatusAsync("event1", new [] { "A-3", "A-5" }, "sold", "wvXbB9MlHt");
			SeatsIo --> AdminAPI: Confirma cambio de estatus
			AdminAPI ->> AdminPortal: Confirma que el proceso fue exitoso
			AdminPortal ->> Cliente: Muestra compra exitosa
			AdminAPI ->> Cliente: Envia correo y entrega Xolopass digital
			Cliente ->> AdminPortal: Puede pedir su Xolopass fisico
			AdminPortal ->> Cliente: Entrega Xolopass fisico de ser necesario
		else Reintento de pago
			AdminAPI -->> AdminPortal: Envia mensaje de pago no procesado
			AdminPortal ->> Cliente: Se notifica al cliente que el pago no fue procesado
			Cliente ->> Cliente: "Decide si <br>- Vuelve a intentar <br>- Elige otra forma de pago y vuelve a empiezar proceso de pago <br>- Cancela" 
		end
	end